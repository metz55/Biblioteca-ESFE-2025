@model IEnumerable<Library.DataAccess.Domain.Loans>
@using System.Text.Json
@{
    ViewData["Title"] = "Todos los Préstamos";
    Layout = "_LayoutP";
    var loanIds = new List<long>();
}
<style>
    body {
        overflow-x: hidden;
    }

    #contenedor-principal {
        border-radius: 0.5rem;
    }

    #contenedor-principal {
        border-radius: 0.5rem;
        transition: all 0.3s ease;
    }

        #contenedor-principal:hover {
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            transform: translateY(-2px);
            border: 1px solid #e5e7eb;
        }

    #btn-create, #btnExportarExcel {
        transition: all 0.3s ease;
    }

        #btn-create:hover, #btnExportarExcel:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

    @@media (max-width: 768px) {
        .form-busqueda {
            flex-direction: column !important;
            align-items: stretch !important;
        }

        .table-responsive {
            overflow-x: auto;
        }

        table.table td,
        table.table th {
            font-size: 14px;
            white-space: nowrap;
        }

        #btnExportarExcel {
            width: 100% !important;
            margin-bottom: 15px;
            background-color: #10B981;
        }
    }

    .pagination-container {
        display: flex;
        justify-content: center;
        margin-top: 15px;
        gap: 5px;
    }

    .page-btn {
        display: inline-block;
        padding: 6px 12px;
        border: 1px solid #d1d5db;
        background-color: #f9fafb;
        color: #374151;
        text-decoration: none;
        border-radius: 5px;
        font-size: 14px;
        transition: all 0.2s ease;
    }

        .page-btn:hover {
            background-color: #e5e7eb;
            color: #111827;
        }

        .page-btn.active {
            background-color: #d1d5db;
            color: #111827;
            font-weight: bold;
            border-color: #9ca3af;
        }

    .fade-page {
        opacity: 0;
        transition: opacity 0.5s ease;
    }

        .fade-page.show {
            opacity: 1;
        }
</style>

<div class="card" id="contenedor-principal">
    <div class="card-body">
        <h1 style="font-family: 'Poppins', sans-serif; font-weight: 600;">Registro de Préstamos</h1>
        <div class="spacer">
            <button type="button" id="btnExportarExcel" class="btn btn-success" style="background-color: #1E7940;">
                <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
            </button>
        </div>
        <hr />
        <div class="table-responsive fade-page show" id="tableContainer">
            <table id="customers" class="table">
                <thead>
                    <tr>
                        <th class="borIz">ID Préstamo</th>
                        <th>Tipo Préstamo</th>
                        <th>Código</th>
                        <th>Nombre del Estudiante</th>
                        <th>Carrera</th>
                        <th>Libro</th>
                        <th>Ejemplar</th>
                        <th>Contacto</th>
                        <th>Fecha Registro</th>
                        <th class="borDer">Estado</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        loanIds.Add(item.ID_LENDER);
                        <tr>
                            <td>@item.LOAN_ID</td>
                            <td>@item.LoanTypes?.TYPES_NAME</td>
                            <td class="tdStudentCode_@item.ID_LENDER">Cargando...</td>
                            <td class="tdStudentName_@item.ID_LENDER">Cargando...</td>
                            <td class="tdStudentCareer_@item.ID_LENDER">Cargando...</td>
                            <td>@item.Books?.TITLE</td>
                            <td>@item.COPY</td>
                            <td>@item.LENDER_CONTACT</td>
                            <td>@item.REGISTRATION_DATE.ToShortDateString()</td>
                            <td>@(item.STATUS ? "Activo" : "Inactivo")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
        @if (ViewBag.TotalPaginas > 1)
        {
            <nav class="pagination-container">
                @if (ViewBag.PaginaActual > 1)
                {
                    <a class="page-btn" href="@Url.Action("AllLoans", new { page = ViewBag.PaginaActual - 1, pageSize = ViewBag.Top })">Anterior</a>
                }
                @for (int i = 1; i <= ViewBag.TotalPaginas; i++)
                {
                    <a class="page-btn @(i == ViewBag.PaginaActual ? "active" : "")" href="@Url.Action("AllLoans", new { page = i, pageSize = ViewBag.Top })">@i</a>
                }
                @if (ViewBag.PaginaActual < ViewBag.TotalPaginas)
                {
                    <a class="page-btn" href="@Url.Action("AllLoans", new { page = ViewBag.PaginaActual + 1, pageSize = ViewBag.Top })">Siguiente</a>
                }
            </nav>
        }
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var loanIds = @Html.Raw(JsonSerializer.Serialize(loanIds));
        loanIds.forEach(function (id) {
            fnBuscarEstudiante(id);
        });
    });

    function fnBuscarEstudiante(id) {
        $.ajax({
            method: 'POST',
            url: '@Url.Action("BuscarEstudianteId", "Loans")',
            data: { id: id },
            datatype: 'json',
            success: function (data) {
                $('.tdStudentCode_' + id).text(data.studentCode || "No disponible");
                $('.tdStudentName_' + id).text(data.fullName || "No disponible");
                $('.tdStudentCareer_' + id).text(data.career || "No disponible");
            },
            error: function () {
                $('.tdStudentCode_' + id).text("No disponible");
                $('.tdStudentName_' + id).text("No disponible");
                $('.tdStudentCareer_' + id).text("No disponible");
            }
        });
    }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
    document.getElementById('btnExportarExcel').addEventListener('click', function () {
        const tabla = document.getElementById('customers');
        // Clonar la tabla sin modificar la original
        const tablaClonada = tabla.cloneNode(true);
        // Reemplazar "Cargando..." por "No disponible"
        const filas = tablaClonada.querySelectorAll('tr');
        filas.forEach(fila => {
            fila.querySelectorAll('td, th').forEach(celda => {
                if (celda.textContent.trim() === "Cargando...") {
                    celda.textContent = "No disponible";
                }
            });
        });
        // Convertir a hoja de Excel
        const ws = XLSX.utils.table_to_sheet(tablaClonada);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Prestamos");
        // Exportar
        XLSX.writeFile(wb, "prestamos.xlsx");
    });
</script>

<!-- Script para la animación de transición al cambiar de página -->
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const container = document.getElementById("tableContainer");
        setTimeout(() => container.classList.add("show"), 50);

        document.querySelectorAll(".page-btn").forEach(link => {
            link.addEventListener("click", function (e) {
                e.preventDefault();
                container.classList.remove("show");
                setTimeout(() => {
                    window.location.href = this.href;
                }, 500);
            });
        });
    });
</script>

