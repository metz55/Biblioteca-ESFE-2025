@using Library.DataAccess.Domain
@using Newtonsoft.Json
@{
    ViewData["Title"] = "Feed";
    Layout = "~/Views/Shared/_LayoutUsers.cshtml";
    var defaultImage = "/img/esfelogo-expanded.png";
    var postImage = "";
    List<Posts> pinnedPosts = ViewBag.pinnedPosts as List<Posts>;
    List<Posts> lastPosts = ViewBag.lastPosts as List<Posts>;
}
<link href="https://fonts.googleapis.com/css?family=Inria+Sans&display=swap" rel="stylesheet" />

<!-- Header Start -->
<div class="jumbotron jumbotron-fluid page-header position-relative overlay-bottom" style="margin-bottom: 90px;">
    <div class="container text-center py-5">
        <h1 class="text-white display-1">Blog</h1>
        <div class="mx-auto mb-5" style="width: 100%; max-width: 600px;">
            <!-- Botón de búsqueda -->
            <form asp-action="Search" method="get" class="d-flex flex-column flex-md-row align-items-center justify-content-center p-4">
                <!-- Input de búsqueda -->
                <div class="w-100">
                    <input type="text" name="Query" class="btn btn-light btn-lg px-4" id="Query" placeholder="Buscar..." />
                </div>

                <!-- Filtros -->
                <div class="d-flex flex-column flex-md-row w-100 justify-content-between">


                    <div class="w-100">
                        <button type="submit" class="btn btn-light btn-lg px-4 shadow-sm mt-1">
                            <i class="fas fa-search"></i> Buscar publicaciones
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
<!-- Header End -->
@if (pinnedPosts != null && pinnedPosts.Count > 0)
{
    <div class="container-fluid py-1">
        <div class="container py-1">
            <div class="section-title text-center position-relative mb-5">
                <h6 class="d-inline-block position-relative text-secondary text-uppercase pb-2">Destacadas</h6>
                <h1 class="display-5">Publicaciones Importantes</h1>
            </div>

            @if (pinnedPosts.Count > 3)
            {
                <!-- Carrusel -->
                <div class="owl-carousel team-carousel position-relative" style="padding: 0 30px;">
                    @foreach (var post in pinnedPosts)
                    {
                        postImage = post.IMAGES.Take(1).FirstOrDefault()?.PATH ?? defaultImage;
                        <div class="team-item">
                            <a href="/Posts/Details/@post.ID" style="text-decoration:none;">
                                <img class="img-fluid w-100" src="@postImage" alt="@post.TITLE">
                                <div class="bg-light text-center p-4">
                                    <h5 class="mb-3">@post.TITLE</h5>
                                    <p class="mb-2">@post.CATEGORY.Name</p>
                                    <p class="text-muted small">@Html.Raw(post.CONTENT.Length > 100 ? post.CONTENT.Substring(0, 100) + "..." : post.CONTENT)</p>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- Mostrar en tarjetas normales -->
                <div class="row">
                    @foreach (var post in pinnedPosts)
                    {
                        postImage = post.IMAGES.Take(1).FirstOrDefault()?.PATH ?? defaultImage;
                        <div class="col-md-4 col-sm-6 mb-4">
                            <a href="/Posts/Details/@post.ID" style="text-decoration:none;">
                                <div class="card shadow-sm border-0 h-100">
                                    <img class="card-img-top" src="@postImage" alt="@post.TITLE">
                                    <div class="card-body text-center">
                                        <h5 class="card-title">@post.TITLE</h5>
                                        <p class="text-secondary">@post.CATEGORY.Name</p>
                                        <p class="text-muted small">@Html.Raw(post.CONTENT.Length > 100 ? post.CONTENT.Substring(0, 100) + "..." : post.CONTENT)</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
}

@if (lastPosts != null && lastPosts.Count > 0)
{
    <!-- Últimas Publicaciones -->
    <div class="container mt-4">
        <h2 class="fw-bold mb-3">Últimas publicaciones</h2>
        <div class="row">
            @foreach (var post in lastPosts)
            {
                postImage = post.IMAGES.Take(1).FirstOrDefault()?.PATH ?? defaultImage;
                <div class="col-md-3 col-sm-6 mb-4">
                    <a href="/Posts/Details/@post.ID" style="text-decoration:none;">
                        <div class="card shadow-sm border-0 h-100">
                            <img class="card-img-top" src="@postImage" alt="@post.TITLE">
                            <div class="card-body">
                                <p class="text-secondary mb-1">@post.CATEGORY.Name</p>
                                <h5 class="card-title">@post.TITLE</h5>
                                <p class="card-text text-muted">@Html.Raw(post.CONTENT.Length > 80 ? post.CONTENT.Substring(0, 80) + "..." : post.CONTENT)</p>
                            </div>
                        </div>
                    </a>
                </div>
            }
        </div>
    </div>
}
else
{
    <h2 class="text-center fw-bold">No hay publicaciones</h2>
}

@section Scripts {
    <script src="~/lib/owlcarousel/owl.carousel.min.js"></script>
    <script>
        $(".team-carousel").owlCarousel({
            autoplay: true,
            smartSpeed: 1000,
            margin: 30,
            dots: false,
            loop: true,
            nav: true,
            navText: [
                '<i class="bi bi-chevron-left"></i>',
                '<i class="bi bi-chevron-right"></i>'
            ],
            responsive: {
                0: { items: 1 },
                576: { items: 2 },
                768: { items: 3 },
                992: { items: 4 }
            }
        });
    </script>
}